API для получения данных (значений) по полям выбранной сущности (смарт-процесс или сделка).

Этот модуль предоставляет эндпоинт для получения фактических данных из таблиц базы данных
для выбранной сущности. Используется фронтендом после выбора сущности и полей для отображения данных.

Основные функции:
- get_entity_data() - возвращает данные по полям для выбранной сущности

Параметры запроса:
- type (обязательный): тип сущности - "smart_process" или "deal"
- entity_key (опциональный): ключ сущности (обязателен для smart_process, для deal не нужен)
  - Для смарт-процессов: формат "sp:1114" (где 1114 - entity_type_id)
  - Для сделок: не требуется, используется "deal"
- limit (опциональный): максимальное количество записей (по умолчанию 100, максимум 10000)
- offset (опциональный): смещение для пагинации (по умолчанию 0)
- fields (опциональный): список полей через запятую для выборки (если не указано - все поля)

Структура ответа:
{
  "ok": true,
  "entity_key": "sp:1114",
  "type": "smart_process",
  "table_name": "b24_sp_f_1114",
  "total": 1009,
  "count": 100,
  "limit": 100,
  "offset": 0,
  "fields": ["id", "raw", "column1", "column2", ...],
  "data": [
    {
      "id": 12345,
      "raw": {...},
      "column1": "value1",
      "column2": "value2",
      ...
    },
    ...
  ]
}

Примеры использования:
1. Получить данные для сделок (первые 100 записей, все поля):
   GET /api/entity-data/?type=deal

2. Получить данные для смарт-процесса (первые 50 записей, все поля):
   GET /api/entity-data/?type=smart_process&entity_key=sp:1114&limit=50

3. Получить данные с пагинацией (следующие 100 записей):
   GET /api/entity-data/?type=deal&limit=100&offset=100

4. Получить только определенные поля:
   GET /api/entity-data/?type=deal&fields=id,title,opportunity,assigned_by_id

5. Получить данные для смарт-процесса с определенными полями:
   GET /api/entity-data/?type=smart_process&entity_key=sp:1114&fields=id,title,ufCrm34_1749209523&limit=200

ИСТОРИЯ ИЗМЕНЕНИЙ:
==================

2026-01-09 - Создание модуля
    - Создан файл entity_data_api.py
    - Реализован эндпоинт GET /api/entity-data/ для получения данных по полям сущности
    - Принимает параметры: type (smart_process или deal), entity_key (для смарт-процессов), limit, offset, fields
    - Возвращает данные из соответствующих таблиц (b24_sp_f_* для смарт-процессов, b24_crm_deal для сделок)
    - Поддерживает пагинацию через limit и offset
    - Поддерживает выбор конкретных полей через параметр fields
    - Всегда включает базовые поля: id, raw
    - Возвращает общее количество записей (total) и количество в текущем ответе (count)
    - Добавлена функция table_name_for_entity() для определения имени таблицы по entity_key
    - Валидация параметров (проверка type, обязательность entity_key для smart_process)
    - Обработка ошибок и закрытие соединения с БД
    - Роутер подключен в app.py
    - Документация вынесена в entity_data_api.txt

2026-01-09 - Исправление: возврат всех полей из таблицы
    - Изменена логика получения полей: теперь получаем ВСЕ колонки из таблицы через information_schema.columns
    - Если параметр fields не указан, возвращаются ВСЕ колонки из таблицы (не только из мета-таблицы)
    - Это гарантирует, что все значения всех полей будут возвращены в ответе
    - Базовые поля (id, raw) всегда включаются в начало списка
    - Добавлены 4 примера вызовов API в docstring функции для удобства использования

2026-01-09 - Добавление человеко-читаемых названий полей
    - Изменена структура ответа: теперь поля возвращаются с мета-информацией (title, b24_field, column_name, b24_type)
    - В поле "fields" теперь возвращаются объекты с человеко-читаемыми названиями (title) вместо просто списка строк
    - В поле "data" значения возвращаются ТОЛЬКО с ключами-названиями (title) для удобства фронтенда
    - Убраны технические имена из ответа data - фронтенд видит только человеко-читаемые названия
    - Для получения title используется расширенный приоритет: b24_title -> labels (title, label, listLabel, formLabel, filterLabel) -> settings (title, label) -> понятное имя из b24_field
    - Для UF полей (ufCrm34_*) улучшена логика получения title: сначала из b24_title, затем из labels, затем из settings, и только потом fallback на понятное имя
    - Если labels или settings хранятся как JSON строка, они автоматически парсятся
    - Для базовых полей (id, raw, created_at, updated_at) используются понятные названия на русском
    - Фронтенд теперь получает только понятные названия полей, без технических имен типа "ufCrm34_1749209523"

2026-01-09 - Удаление технических имен из ответа fields
    - Изменена структура ответа "fields": теперь возвращаются только человеко-читаемые данные
    - Убраны технические имена (b24_field, column_name) из ответа fields
    - В ответе fields теперь только: title, name (дубликат title), type (тип поля)
    - Фронтенд больше не видит технические имена типа "uf_crm_1739464880408" или "date_modify"
    - Все технические имена скрыты, фронтенд работает только с понятными названиями (title)
