# 999.md — итог и как вручную проверить

## Что сделано

1. **Маппинг и API 999.md**
   - Получены категории/подкатегории/фичи через API (токен работает).
   - Категория 658 (Транспорт), подкатегория 659 (Легковые), тип 776 (Продам).
   - Список полей и опций сохранён в `999md_features_cars_sell.json`, маппинг БД→999 в `999md_db_mapping.md`.

2. **Модуль публикации `publish_999md.py`**
   - Резолв марки/модели в id опций 999 (по названию + dependent_options).
   - Дефолты для обязательных полей 999 (Регистрация, Состояние, Регион Кишинёв и т.д.).
   - Загрузка фото на 999: по URL или с диска → `POST /images` → массив `image_id` в объявление.
   - **Фото из БД**: из `raw["ufCrm34_1756897294"]` (как в auto_send_tg), приоритет `urlMachine`, иначе сборка URL через Bitrix REST `crm.controller.item.getFile` (нужен `BITRIX_WEBHOOK`).

3. **Endpoints в приложении**
   - **GET** `/api/publish-999md/adverts` — список объявлений (черновики в ответе имеют `state=draft`).
   - **GET** `/api/publish-999md/adverts/{advert_id}` — полные данные объявления (title, price, state, images, contacts).
   - **GET** `/api/publish-999md/adverts/{advert_id}/features` — фичи объявления (марка, модель, год, цена, описание и т.д.).
   - **POST** `/api/publish-999md/publish`
   - Два варианта:
     - **По `item_id`** — данные и фото из `b24_sp_f_1114.raw` (марка, модель, год, цена, пробег, фото).
     - **По телу** — `marca`, `model`, `year`, `price` + `image_urls` или `image_paths`.

4. **Env**
   - `API_999MD_TOKEN` — токен 999.md (обязательно).
   - `BITRIX_WEBHOOK` — для скачивания фото из БД при публикации по `item_id`.
   - `PUBLISH_999MD_PHONE` — телефон в объявлении при публикации из БД (опционально).

---

## Как вручную вызвать API и проверить, что объявление пришло на 999.md

### 1. Запусти приложение на сервере (194.33.40.197)

Чтобы API был доступен **снаружи** (не только localhost), слушаем на всех интерфейсах: **0.0.0.0**. Порт — например **4040**.

```bash
cd /path/to/CRM
# Загрузи .env (API_999MD_TOKEN, BITRIX_WEBHOOK и т.д.)
uvicorn app:app --host 0.0.0.0 --port 4040
```

- **--host 0.0.0.0** — слушать на всех интерфейсах, доступ с других машин (например `http://194.33.40.197:4040`).
- **--port 4040** — порт (можешь поменять на свой).

### 2. Вариант A: проверка по item_id (данные и фото из БД)

Подставь реальный **id** записи из таблицы `b24_sp_f_1114` (у которой есть марка, модель, цена и фото в `raw`).

**С другой машины (PowerShell) — подставь свой item_id:**

```powershell
$body = '{"item_id": 12345}'
Invoke-RestMethod -Uri "http://194.33.40.197:4040/api/publish-999md/publish" -Method POST -ContentType "application/json" -Body $body
```

**Или curl:**

```bash
curl -X POST "http://194.33.40.197:4040/api/publish-999md/publish" -H "Content-Type: application/json" -d "{\"item_id\": 12345}"
```

Если приложение на другом порту или за HTTPS — замени `194.33.40.197:4040` на свой адрес (например `https://твой-домен.ru`).

Успех: в ответе будет `"ok": true` и `"999md": {"advert": {"id": "..."}}`. Этот **id** — id объявления на 999.md (открой в браузере: `https://999.md/...` по этому id, если сайт так устроен).

### 3. Вариант B: проверка с явными полями и одним фото по URL

Нужна **рабочая ссылка на картинку** (доступная по HTTP без авторизации). Пример с тестовой картинкой:

```powershell
$body = @'
{
  "marca": "Toyota",
  "model": "Camry",
  "year": 2020,
  "price": 15000,
  "price_unit": "eur",
  "mileage_km": 50000,
  "description": "Тест из API.",
  "phone": "37378123456",
  "image_urls": ["https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/2019_Toyota_Camry_XSE.jpg/320px-2019_Toyota_Camry_XSE.jpg"]
}
'@
Invoke-RestMethod -Uri "http://194.33.40.197:4040/api/publish-999md/publish" -Method POST -ContentType "application/json; charset=utf-8" -Body ([System.Text.Encoding]::UTF8.GetBytes($body))
```

Успех: снова `"ok": true` и `"999md": {"advert": {"id": "..."}}` — объявление создано на 999.md.

### 4. Что проверить по ответу

- **200** и `"ok": true`, `"999md": {"advert": {"id": "ЧИСЛО"}}` — объявление ушло на 999.md, id объявления в ответе.
- **400** — нет фото, нет марки/модели или не найден item_id/данные в БД.
- **502** — ошибка от API 999.md (текст в `detail`).
- **503** — не задан `API_999MD_TOKEN`.

Проверка «пришло ли объявление»: зайди в личный кабинет 999.md (под аккаунтом, к которому привязан токен) и посмотри список объявлений — там должно появиться новое с указанным id.

### 5. Получить черновик по API (структура как на 999)

Черновики в списке имеют **state=draft** (не hidden). Получить одно объявление и его фичи:

```bash
# Список объявлений (в т.ч. черновики)
curl "http://194.33.40.197:4040/api/publish-999md/adverts?page_size=10"

# Одно объявление по id (например 103367648)
curl "http://194.33.40.197:4040/api/publish-999md/adverts/103367648"

# Фичи объявления (марка, модель, год, цена, описание)
curl "http://194.33.40.197:4040/api/publish-999md/adverts/103367648/features"
```

Локально можно запустить скрипт `fetch_999md_draft_advert.py` — он получит первое объявление с 999.md и сохранит в `999md_draft_advert_example.json` и `999md_draft_advert_features.json` (структура для сверки с нашим payload).
