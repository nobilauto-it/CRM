# 999.md — что сделать на сервере и как отправить объявление вручную

## 1. Что положить на сервер

- Файлы проекта (как обычно деплой): `app.py`, `publish_999md.py`, `999md_features_cars_sell.json`, остальные модули и зависимости.
- Файл `999md_features_cars_sell.json` должен лежать **рядом с** `publish_999md.py` (в той же папке), иначе публикация не найдёт список марок.

## 2. Переменные окружения на сервере

Добавь в окружение, откуда запускается приложение (systemd, .env, панель хостинга):

```bash
# Токен 999.md Partners API (обязательно для публикации)
export API_999MD_TOKEN="TreE0PnGG7MGZJUuxZUwDWN_UZNY"

# Bitrix webhook — нужен для скачивания фото из БД (raw[ufCrm34_1756897294] → urlMachine / crm.controller.item.getFile)
# Без него фото по item_id не подтянутся (если в raw только url ajax.php)
export BITRIX_WEBHOOK="https://nobilauto.bitrix24.ru/rest/18397/h5c7kw97ote"

# Телефон в объявлении при публикации по item_id (опционально)
export PUBLISH_999MD_PHONE="37361252222"
```

**Важно:** не коммить токен в репозиторий. На сервере задавать через env или секреты.

Остальные переменные (PG_*, TG_TOKEN и т.д.) — как уже настроены для CRM.

## 3. Зависимости

Ничего дополнительного не нужно: используется уже стоящий `requests` и стандартные библиотеки. FastAPI/Pydantic у тебя уже есть (app.py).

## 4. Запуск приложения

На машине **194.33.40.197** (или другой) нужно слушать на **0.0.0.0**, чтобы API был доступен снаружи. Порт — например **4040**:

```bash
uvicorn app:app --host 0.0.0.0 --port 4040
```

- **--host 0.0.0.0** — слушать на всех интерфейсах (доступ по http://194.33.40.197:4040 с других машин).
- **--port 4040** — порт (при необходимости замени на свой).

Или через systemd/gunicorn — в unit-файле укажи те же `--host 0.0.0.0` и `--port 4040`.

## 5. Ручная отправка объявления на 999.md

Endpoint:

- **POST** `http://194.33.40.197:4040/api/publish-999md/publish` (если приложение на этой машине и порту; иначе подставь свой адрес)

Тело — JSON. Обязательные поля:

- `marca` — марка (например `"Toyota"`, `"BMW"`).
- `model` — модель (например `"Camry"`, `"X5"`).
- `year` — год выпуска (число, например `2020`).
- `price` — цена (число, например `15000`).
- Минимум одно фото: либо `image_urls`, либо `image_paths`.

Остальное по желанию.

### Пример 1: фото по URL

```bash
curl -X POST "http://194.33.40.197:4040/api/publish-999md/publish" \
  -H "Content-Type: application/json" \
  -d '{
    "marca": "Toyota",
    "model": "Camry",
    "year": 2020,
    "price": 15000,
    "price_unit": "eur",
    "mileage_km": 50000,
    "description": "В хорошем состоянии.",
    "numar_auto": "ABC 123",
    "phone": "37378123456",
    "image_urls": ["https://example.com/photo1.jpg"]
  }'
```

### Пример 2: публикация по item_id (данные и фото из БД)

Если машина уже в таблице `b24_sp_f_1114`, можно отправить на 999 только её id. Марка, модель, год, цена, пробег и **фото** берутся из `raw` (поле фото — `ufCrm34_1756897294`, приоритет `urlMachine`, иначе сборка URL через Bitrix REST `crm.controller.item.getFile`). На сервере должен быть задан `BITRIX_WEBHOOK`.

```bash
curl -X POST "http://194.33.40.197:4040/api/publish-999md/publish" \
  -H "Content-Type: application/json" \
  -d '{"item_id": 12345}'
```

Ответ при успехе: `{"ok": true, "999md": {"advert": {"id": "..."}}, "source": "db", "item_id": 12345}`.

### Пример 3: фото — локальные файлы на сервере

Если файлы уже лежат на сервере (например после загрузки):

```bash
curl -X POST "http://194.33.40.197:4040/api/publish-999md/publish" \
  -H "Content-Type: application/json" \
  -d '{
    "marca": "Toyota",
    "model": "Camry",
    "year": 2020,
    "price": 15000,
    "image_paths": ["/var/www/uploads/car1.jpg", "/var/www/uploads/car2.jpg"]
  }'
```

Пути в `image_paths` — от корня файловой системы сервера; приложение должно иметь право читать эти файлы.

### Успешный ответ

```json
{
  "ok": true,
  "999md": {
    "advert": {
      "id": "12345678"
    }
  }
}
```

По этому `id` можно открыть объявление на 999.md.

### Ошибки

- **503** — не задан `API_999MD_TOKEN` на сервере.
- **400** — нет фото или не найдены марка/модель на 999 (проверь написание: как на 999, например `"Toyota"`, `"Camry"`).
- **502** — ошибка от API 999.md (в `detail` будет текст ответа 999).

## 6. Краткий чеклист на сервере

1. Выложить код с `publish_999md.py` и `999md_features_cars_sell.json`.
2. Задать в окружении `API_999MD_TOKEN`.
3. Перезапустить приложение.
4. Проверить ручную отправку: `POST /api/publish-999md/publish` с телом из примеров выше (подставь свой URL сервера и при необходимости свои фото).

Дальше можно автоматизировать: вызывать этот же endpoint по `deal_id` из БД или по вебхуку.
