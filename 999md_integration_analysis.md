# Анализ: публикация объявлений о машинах на 999.md

## Текущий поток (что «кидаем из базы в Telegram»)

- **Источник данных**: БД (PostgreSQL) — сделки/склад авто.
- **Используемые поля** (по коду в `api_data.py`, `send_reports_telegram.py`):
  - `title` (Nr tranzacției / заголовок сделки)
  - `marca` (бренд, `brand_val` / DEALS_F_BRAND)
  - `model` (модель, `model_val` / DEALS_F_MODEL)
  - `numar_auto` (номер авто, `carno_val` / DEALS_F_CARNO)
  - цена: `total_suma`, `pret`, поля продления (prel1_prel, …)
  - даты: выдача/возврат, продления
  - ответственный: `assigned_by_name` / `responsabil`
- **Куда идёт**: в Telegram — либо PDF-отчёт по филиалу (`send_pdf_to_telegram`), либо текстовое сообщение по отчёту `/api/data/reports/automobile` (deal_id, responsabil, numar_auto, marca, model, zile, total).

То есть «сообщение о новой машине» по смыслу — это **одна запись/сделка** с полями: марка, модель, номер авто, цена, описание (если есть), фото (если есть).

---

## 999.md Partners API — что нужно для объявления

- **Базовый URL**: `https://partners-api.999.md`
- **Авторизация**: HTTP Basic Auth. **Username** = секретный API-ключ (токен), **Password** = пустой.  
  Токен хранить в переменной окружения (например `API_KEY_999MD` или `PARTNERS_999MD_TOKEN`) и не светить в коде/репозитории.
- **Документация**: https://partners-api.999.md/api/documentation

### Создание объявления (одна машина)

- **Метод**: `POST /adverts`
- **Тело**: JSON с полями:
  - `category_id` (строка) — категория
  - `subcategory_id` (строка) — подкатегория
  - `offer_type` (строка) — тип предложения
  - `features` (массив объектов) — все поля объявления в виде фич с `id`, `value` и при необходимости `unit`

Для **легковых автомобилей / Продам** по доке:
- Категория: **658** (Транспорт)
- Подкатегория: **659** (Легковые автомобили)
- Тип предложения: **776** (Продам)

Список **фич** (поля объявления) для этой комбинации нужно брать из API:
- `GET /features?category_id=658&subcategory_id=659&offer_type=776&lang=ru` (или `lang=ro`)

В ответе — группы фич с `id`, `title`, `type`, `required`, `units`, `options` и т.д. Примеры из доки:
- цена: тип `textbox_numeric_measurement`, единицы `eur`, `usd`, `mdl`
- заголовок: тип `textbox_text` (в примере id `12` — title)
- описание: тип `textarea_text` (id `13` — description)
- контакты: тип `contacts`, значение — массив телефонов (id `16`)
- фото: тип `upload_images`, значение — массив `image_id` (id `14` в примере)

Картинки сначала загружаются:
- `POST /images` (multipart/form-data, поле `file`)  
- В ответе — `image_id`, его и подставлять в фичу типа `upload_images`.

Язык: параметр `lang` (ru/ro); для заголовка/описания можно передать объект `{"ru": "...", "ro": "..."}` в фичах 12/13.

---

## Как связать «данные из базы» и «объявление на 999.md»

| Наши данные (БД/сделка) | 999.md |
|--------------------------|--------|
| Марка (marca)            | Фича «марка» (скорее всего `drop_down_options` — нужен id опции из `/features` или `/dependent_options`) |
| Модель (model)           | Фича «модель» (часто зависит от марки — `dependent_options`) |
| Цена                     | Фича с типом `textbox_numeric_measurement` (id из features), value + unit (eur/usd/mdl) |
| Заголовок                | Фича title (например id 12): короткий текст |
| Описание                 | Фича description (например id 13): текст с переносами |
| Номер авто               | Можно в описание или в доп. текстовую фичу, если есть |
| Фото                     | Загрузить через `POST /images`, затем массив `image_id` в фичу `upload_images` |
| Телефон                  | Фича `contacts` — массив номеров в международном формате |

Важно: точные `id` полей (марка, модель, год, пробег и т.д.) для подкатегории 659 нужно взять один раз из `GET /features?...` и зашить в маппинг в коде (или в конфиг).

---

## Предлагаемая схема реализации (без кода — только идея)

1. **Точка входа**
   - Вариант A: отдельный endpoint в приложении, например `POST /api/publish-999md` с `deal_id` или `entity_type_id` + `entity_id`, который по этой сделке/записи из БД собирает данные и один раз дергает 999.md.
   - Вариант B: после обработки вебхука Bitrix (новая/обновлённая сделка) в воркере очереди вызывать функцию «опубликовать на 999.md» для этой сделки (если по правилам нужно публиковать).
   - Вариант C: джоба по расписанию — выбирает сделки «к публикации на 999» и по одной отправляет в 999.md.

2. **Шаги в коде**
   - Взять по сделке/записи из БД: marca, model, price, title, description, номера телефонов, фото (URL или файлы).
   - Опционально один раз (или по кэшу) запросить `GET /features?category_id=658&subcategory_id=659&offer_type=776` и сохранить маппинг «название поля → feature id».
   - Для марки/модели: при необходимости вызывать `GET /dependent_options` (модель зависит от марки).
   - Загрузить фото: для каждого изображения `POST /images`, собрать список `image_id`.
   - Собрать массив `features`: цена (value + unit), заголовок, описание, контакты, upload_images, марка/модель/год и т.д. по маппингу.
   - `POST https://partners-api.999.md/adverts` с Basic Auth (токен из env) и JSON body.
   - Обработать ответ 201 (успех, в теле id объявления) и 4xx (ошибка валидации/формата).

3. **Токен**
   - Хранить в env (например `API_KEY_999MD`). В коде только подставлять в заголовок Basic Auth как username с пустым паролем.

4. **Ограничения**
   - Публикация через API платная (по тарифам 999.md).
   - Лимит загрузки изображений — до 1200 в день (по доке).

Итого: «то же, что кидаем из базы в Telegram» (одна машина: марка, модель, номер, цена, описание, фото) можно отобразить в виде одного объявления на 999.md через `POST /adverts`, предварительно получив список фич, загрузив картинки в `/images` и положив токен в переменную окружения.
